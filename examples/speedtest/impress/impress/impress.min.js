const e=new Map,t=new Map,r={},a={},s=new Map;a.getValueFromResolvedPath=(e,t)=>t.reduce(((e,t)=>e=e instanceof Map||e instanceof Set?e.get(t):e?.[t]),e),r.error=(e,t,...r)=>{switch(e){case"setiPropsMaps":throw new Error(`iMpress error --- props ${r[0]}="${r[1]}" is declared on ${t.name} but "${r[1]}" cannot be found on parent or super parent`);case"setiEventMaps":throw new Error(`iMpress warning --- i-event "${r[0]}" method ${r[1]}() is not declared in "${t?.name}" or parent passthroughs`);case"i-for":throw new Error(`iMpress error --- i-for component: ${t._impressInternal.iGuid} - a valid iteratable must be set (Array, Set, Map).`);case"i-if":throw new Error(`iMpress error --- i-if component: ${t._impressInternal.iGuid} - does not have a valid reactive condition attribute.`);case"getResolvedDataPathArrayWithResolvedKeys":throw new Error(`iMpress error --- "${r[0]}" is referenced on ${t.name} but cannot be found on parent or super parent`);case"getReactiveMapFromBaseMap":throw new Error(`iMpress error --- "${r[0]}" is declared on ${t.name} but cannot be found on parent or super parent`);case"templateType":throw new Error(`iMpress error --- ${t.name} - template is not typeof "string"`)}},r.warn=(e,t,...r)=>{if("mixin"===e)console.warn(`iMpress warning --- mixin declared in ${t.name} is not of IMPRESS class type`)},r.setStateChangeLog=(e,t,r,i)=>{let n=i.join("."),l=null;try{l=structuredClone(a.getValueFromResolvedPath(r,i))}catch(e){}!1===s.has(r._impressInternal.iGuid)&&s.set(r._impressInternal.iGuid,new Map);let o=s.get(r._impressInternal.iGuid);!1===o.has(n)&&o.set(n,new Set);let p=o.get(n);if(p.add({callerGuid:e._impressInternal.iGuid,callerName:e.name,callerPathArray:t.join("."),value:l,timestamp:Date.now()}),p.size>10)for(let e of p){p.delete(e);break}},r.getStateChangeLog=(e,t)=>{let r=t.join("."),a="string"==typeof e?e:e?._impressInternal?.iGuid,i=s.get(a);if(null!=i)return i.get(r)},r.getStateChangeByGuid=(e,r)=>{r="string"==typeof r?r.match(/[^\[\]\.\{\}]+/g):r.slice();let a=t.get(e);if(null!=a){return a.iGetState(r)}},r.setGlobalMethod=(e=!1)=>{e?window.$idebug=r.getStateChangeByGuid:"function"==typeof window.$idebug&&delete window.idebug};const i={};let n=1e3;i.newGUID=function(){return n+=5,`#${n.toString(36)}`},i.updateAllChildren=(e,t)=>{let r=[new Set([e])],a=new Set,s=0;for(;null!=r[s];){r[s].forEach((s=>{if(!0!==s._impressInternal.controlFlags.isSkipRefresh){let n=s._impressInternal.reactiveLookupMaps.get(e);null!=n&&n.forEach(((e,r)=>{let n=r.split("."),l=!0,o=0;if(t.length<=n.length)for(let e=0;e<t.length;e++){let r;if("?"!==n[e]?r=n[e]:(r=s._impressInternal.keys[o],o++),t[e]!==r){l=!1;break}}else l=!1;!0===l&&e.forEach((e=>{let t=s._impressInternal.reactiveMaps.get(e);if(!1===a.has(t)){let r=t.resolvedPath;if(i.refreshLookupDataMap(s,t),t.resolvedPath!==r){let a=s._impressInternal.reactiveLookupMaps.get(t.resolvedDataOwner),n=a.get(r);n.delete(e),0===n.size&&a.delete(r),i.setReactiveLookup(s,t.resolvedDataOwner,t.resolvedPath,e)}a.add(t)}let r=i.getValueFromLookup(t.resolvedDataOwner,t.reactiveSubMap,t.resolvedDataPathArray,s._impressInternal.keys);if("props."===t.name.substring(0,6)){let a="slot."===e.substring(0,5)?s._impressInternal.iParent:s;i.setDataFromPath(a,t.name.split("."),r)}if("function"==typeof s.iRender)s.iRender(t,!1,r);else{let r="slot."===e.substring(0,5)?s._impressInternal.iNode.host:s._impressInternal.iNode;i.setReactiveDataToDOM(s,r,t,!1,s._impressInternal.keys)}}))})),"function"==typeof s.afterUpdated&&s.afterUpdated(),s._impressInternal.iChildren.size>0&&r.push(s._impressInternal.iChildren)}else delete s._impressInternal.controlFlags.isSkipRefresh})),s++}},i.setReactiveDataToDOM=(e,t,r,a=!1,s)=>{let n=i.getValueFromLookup(r.resolvedDataOwner,r.reactiveSubMap,r.resolvedDataPathArray,s);r.targetMap.forEach(((s,l)=>{if("OBSERVER"===s){let t=e._impressInternal.iObservers.get(r.name);!1===a&&"function"==typeof e[t]&&e[t](n)}else if("TEXT"===s)i.refreshTextNodes(t,l,n);else if("STYLE"===s){let e=t.querySelector("style"),r=new RegExp(`/\\*${l}\\*/.*/\\*${l}\\*/`);e.innerHTML=e.innerHTML.replace(r,`/*${l}*/${n}/*${l}*/`)}else"props"!==s.substring(0,5)&&i.refreshAttribute(t,l,s,n,a)}))},i.getPropMap=(e,t,r)=>{let a=`props.${"#"===r[1][0]?t.get(r[1]).value:r[1]}`;return e._impressInternal.reactiveMaps.get(a)},i.getResolvedDataPathArrayWithResolvedKeys=(e,t,a)=>{let s=`props.${"#"===a[1][0]?t.get(a[1]).value:a[1]}`,i=e._impressInternal.reactiveMaps.get(s);if(null!=i){let t=[...i.resolvedDataPathArray,...a.slice(2)],r=0;for(let a=0;a<t.length;a++)"?"===t[a]&&(t[a]=e._impressInternal.keys[r],r++);return{resolvedDataPathArray:t,resolvedDataOwner:i.resolvedDataOwner}}r.error("getResolvedDataPathArrayWithResolvedKeys",e,s)},i.getValueFromLookup=(e,t,r,a)=>{let s=0;return(Array.isArray(r)?r:r.match(/[^\[\]\.\{\}]+/g)).reduce(((e,r)=>("?"===r?(e=e instanceof Map?e.get(a[s]):e instanceof Set?a[s]:e?.[a[s]],s++):e="#"!==r?.[0]?e instanceof Map?e.get(r):e instanceof Set?r:e?.[r]:e instanceof Map||e instanceof Set?e.get(t.get(r)?.value):e?.[t.get(r)?.value],e)),e)},i.getResolvedDataPathArray=(e,t=e)=>{let r=e!=t?[...e.resolvedDataPathArray,...t.dataPathArray.slice(2)]:t.dataPathArray.slice();for(let a=0;a<r.length;a++){let s=r[a];"?"===s?r[a]="?":"#"===s[0]&&(r[a]=1===a?e.reactiveSubMap.get(s).value:t.reactiveSubMap.get(s).value)}return r},i.isComponentHasOwnData=(e,t)=>{if(null!=e.resolvedDataOwner){let r=e.resolvedDataPathArray.slice(0,e.resolvedDataPathArray.length-1),a="?"!==e.resolvedDataPathArray[e.resolvedDataPathArray.length-1]?e.resolvedDataPathArray[e.resolvedDataPathArray.length-1]:t[t.length-1],s=i.getValueFromLookup(e.resolvedDataOwner,void 0,r,t);if(null!=s)if(s instanceof Set||s instanceof Map){if(s.has(a))return!0}else if("object"==typeof s&&Object.hasOwn(s,a))return!0}return!1},i.refreshLookupDataMap=(e,t)=>{if(t.reactiveSubMap.forEach(((r,a)=>{let s=r.dataOwner,n=r.dataPathArray;if("props"===r.dataPathArray[0]){let a=i.getPropMap(e,t.reactiveSubMaps,r.dataPathArray);n=[...a.dataPathArray,...dataPathArray.slice(2)],s=a.dataOwner}r.value=i.getValueFromLookup(s,t.reactiveSubMap,n)})),t.reactiveSubMap.size>0)if("props"===t.dataPathArray[0]){let e=i.getPropMap(t.dataOwner,t.reactiveSubMap,t.dataPathArray),r=i.getResolvedDataPathArray(e,t);t.resolvedDataOwner=e.resolvedDataOwner,t.resolvedDataPathArray=r}else{let e=i.getResolvedDataPathArray(t);t.resolvedDataPathArray=e}t.resolvedPath=t.resolvedDataPathArray.join(".")},i.setReactiveLookup=(e,t,r,a)=>{if(!1===e._impressInternal.reactiveLookupMaps.has(t)){let s=new Map;e._impressInternal.reactiveLookupMaps.set(t,s),s.set(r,new Set([a]))}else{let s=e._impressInternal.reactiveLookupMaps.get(t);s.has(r)?s.get(r).add(a):s.set(r,new Set([a]))}},i.setReactiveMap=(e,t,r)=>{!1===e._impressInternal.reactiveMaps.has(t)&&e._impressInternal.reactiveMaps.set(t,r),i.setReactiveLookup(e,r.resolvedDataOwner,r.resolvedPath,t),r.reactiveSubMap.forEach(((t,a)=>{if("props"===t.dataPathArray[0]){let a=i.getPropMap(e,r.reactiveSubMap,t.dataPathArray);i.setReactiveLookup(e,a.resolvedDataOwner,a.resolvedPath,r.name)}else i.setReactiveLookup(e,t.dataOwner,t.dataPath,r.name)}))},i.getReactiveMap=(e,t,r,a="TEXT",s=new Map([[r,a]]))=>{let n=new Map,p=0,h=[];for(;p++<t.length;)"["===t[p-1]&&('"'===t[p]||"'"===t[p]||h.push(p));let d=null!=e?._impressInternal?.iNode?e:void 0;for(let r=h.length-1;r>=0;r--){let a=h[r],s=t.indexOf("]",a),l=t.substring(a,s),p=l.split("."),m=Number(l),c=isFinite(m)?m:i.newGUID(),u=d,f=p;if("props"===p[0]&&null!=d){let t=i.getPropMap(e,n,p);f=[...t.dataPathArray,...p.slice(2)],u=t.dataOwner}if("data"===p[0]||"props"===p[0]){let e=new o(l,p,d);e.value=i.getValueFromLookup(u,n,f),n.set(c,e)}t=`${t.slice(0,a-1)}.${c}${t.slice(s+1)}`}let m="props"===a.substring(0,5)||"EVENTHANDLER"===a||!1===t.includes("[props")&&0!==t.indexOf("props"),c=new l(s,t,d,void 0,n,a);if(!0===m)if("props"===c.dataPathArray[0]){let t=i.getPropMap(e,c.reactiveSubMap,c.dataPathArray);if(null!=t){let e=i.getResolvedDataPathArray(t,c);c.resolvedDataOwner=t.resolvedDataOwner,c.resolvedDataPathArray=e,c.resolvedPath=c.resolvedDataPathArray.join("."),t.reactiveSubMap.forEach(((e,t)=>{"data"===e.dataPathArray[0]&&c.reactiveSubMap.set(t,e)}))}else c.resolvedDataOwner=void 0}else{let e=i.getResolvedDataPathArray(c);c.resolvedDataPathArray=e,c.resolvedPath=c.resolvedDataPathArray.join(".")}return c},i.cloneReactiveMap=(e,t)=>{let r=new Map;return e.reactiveSubMap.forEach(((a,s)=>{let n=new o(a.dataPath,a.dataPathArray.slice(),t);n.value=i.getValueFromLookup(n.dataOwner,e.reactiveSubMap,n.dataPathArray),r.set(s,n)})),new l(e.targetMap,e.dataPath,t,e.resolvedPath,r,e.name)},i.getReactiveMapFromBaseMap=(e,t={},a,s=e,n=!1)=>{!0===e._impressInternal.controlFlags.globalState?.has(a)&&(s=e._impressInternal.iRoot);let l=i.cloneReactiveMap(t,s);l.name=a;let o=!0===n?`slot.${l.name}`:l.name;if(!0===e._impressInternal.reactiveMaps.has(o))l=e._impressInternal.reactiveMaps.get(o),t.targetMap.forEach(((e,t)=>{l.targetMap.set(t,e)}));else if("props"===l.dataPathArray[0]){let t=i.getPropMap(s,l.reactiveSubMap,l.dataPathArray);if(null!=t){let r=i.getResolvedDataPathArray(t,l);l.dataOwner=e,l.resolvedDataPathArray=r,l.resolvedPath=r.join("."),l.resolvedDataOwner=t.resolvedDataOwner,t.reactiveSubMap.forEach(((e,t)=>{"data"===e.dataPathArray[0]&&l.reactiveSubMap.set(t,e)}))}else l.resolvedDataOwner=void 0}let p=!0===s?._impressInternal.controlFlags.isPassThrough;return i.isComponentHasOwnData(l,e._impressInternal.keys)?l:!0===p?i.getReactiveMapFromBaseMap(e,t,a,s._impressInternal.iParent,n):void r.error("getReactiveMapFromBaseMap",e,a)},i.refreshTextNodes=(e,t,r)=>{let a=e.querySelector(`[i-data="${t}"]`);null!=a&&(a.textContent=r)},i.refreshAttribute=(e,t,r,a,s)=>{let i=e.querySelector(`[i-attribute="${t}"]`);null!=i&&(!1===s&&"value"===r&&"input"===i.localName?i.value=a:i.setAttribute(r,a))},i.setDataFromPath=(e,t,r)=>{let a=t.slice(),s=a.pop(),n=i.getValueFromLookup(e,void 0,a);null!=n&&(n[s]=r)},i.getDataFromPath=(e,t,r)=>i.getValueFromLookup(e,void 0,t,r),i.setCustomObserverReactiveMaps=(e,t)=>{let r={data:void 0};null!=e&&"object"==typeof e&&e.forEach(((e,a)=>{if(!0===t.has(a)){t.get(a).targetMap.set(i.newGUID(),"OBSERVER")}else{let e=i.getReactiveMap(r,a,i.newGUID(),"OBSERVER");t.set(a,e)}}))};class l{constructor(e,t,r,a,s,i){this.targetMap=e,this.dataPath=t,this.dataPathArray="string"==typeof t?t.split("."):void 0,this.dataOwner=r,this.resolvedDataOwner=r,this.resolvedDataPathArray=this.dataPathArray,this.resolvedPath=a,this.reactiveSubMap=s,this.name="string"!=typeof i||"data"!==i.substring(0,4)&&"props"!==i.substring(0,5)?null:i}}class o{constructor(e,t,r,a){this.dataPath=e,this.dataPathArray=t,this.dataOwner=r,this.value=a}}const p={},h={setTemplateAttributeMaps:(e,t,r,a)=>{for(let s of e){let[e,n]=s.split("=");if('"'===n[0]&&(n=n.substring(1,n.length-1)),n=n.replaceAll("&quot;",'"'),"i-event"===e){n=JSON.parse(n);let e=Object.entries(n);!1===a.has(t)&&a.set(t,new Map);let r=a.get(t);for(let t of e){let[e,a]=t;e=e.trim(),a=a.replace("()","").replace("(",",").replace(")","").split(",");let s=a.length;for(;s--;)a[s]=a[s].trim();1===a.length&&a.push("$e"),r.has(e)?r.get(e).push(a):r.set(e,[a])}}else{let a=n.substring(1,n.length-1),s={data:void 0};if(!0===r.has(a)){r.get(a).targetMap.set(t,e)}else{let n=i.getReactiveMap(s,a,t,e);r.set(a,n)}}}},wrapInSpan:(e,t)=>{let r,a=i.newGUID(),s=e.substring(1,e.length-1);return!0===t.has(s)?(r=t.get(s),r.targetMap.set(a,"TEXT")):(r=i.getReactiveMap({data:void 0},s,a,"TEXT"),t.set(s,r)),`<span i-data="${a}">${e}</span>`},createDynamicStyle:(e,t)=>{let r,a=i.newGUID(),s=e.substring(1,e.length-1);return!0===t.has(s)?(r=t.get(s),r.targetMap.set(a,"STYLE")):(r=i.getReactiveMap({data:void 0},s,a,"STYLE"),t.set(s,r)),`/*${a}*//*${a}*/`}};p.iAttributesHtml=function(t,r=new Map,a=new Map){let s,n=0,l=0;const o=function(t,r){if("<"===t[0]){let a=t.match(/<[\s/]*[^\s>]+/)?.[0];null!=a&&(a=a.replace("/",""),a=a.replace("<",""),a=a.trim(),!0===e.has(a)&&("</"===t.substring(0,2)?r--:r++))}return r};if(s=t.match(/(<[^>]+)>|[^<]+|-->/g),null!=s){for(let t=0,p=s.length;t<p;t++){let p=s[t];if("\x3c!--"===p.substring(0,4)?l++:"--\x3e"===p.substring(p.length-3)&&l>0&&l--,!(l>0))if(n=o(p,n),n>0)"/>"===p.substring(p.length-2)&&l--;else if("<"===p[0]){if(p.includes("{props")||p.includes("{data")||p.includes("i-event")){let n=p.match(/<[^\s]+/);n=n[0].slice(1);let l=p.match(/[a-z-]+={[^}]+}|[a-z-]+="{[^}]+}"/g);if(null!=l&&!e.get(n)){let e=i.newGUID(),n=0,o=l.length;for(h.setTemplateAttributeMaps(l,e,r,a);n<o;)s[t]=0===n?s[t].replace(l[n],`i-attribute="${e}"`):s[t].replace(l[n],""),n++}}}else(p.includes("{props")||p.includes("{data"))&&("<style"===s[t-1]?.substring(0,6)?(s[t]=s[t].replace(/[\t\n]/g,"").trim(),s[t]=s[t].replace(/{data[^}]+}|{props[^}]+}/g,(e=>h.createDynamicStyle(e,r)))):s[t]=s[t].replace(/{data[^}]+}|{props[^}]+}/g,(e=>h.wrapInSpan(e,r))))}t=s.reduce(((e,t)=>e+t))}return t},p.correctHtml=function(e){if("string"==typeof e){let t=(e=(e=(e=(e=e.replace(/[\r\n]/g," ")).replace(/\>\s+(?=<)/g,">")).replace(/<\s+/g,"<")).trim()).match(/[^\{]+?(?=})/g);if(t)for(let r=0;r<t.length;r++){let a=t[r].trim();e.replace(`{${t[r]}}`,`{${a}}`)}return e}};const d=new Map,m={};class c{constructor(t){this.name=t.name,this._ireactive=new Map,this._ievents=new Map,"function"!=typeof t.template?(this.template=t.template,null!=this.template&&""!==this.template?(this.template=p.correctHtml(this.template),this.template=p.iAttributesHtml(this.template,this._ireactive,this._ievents)):this.template="",this.templateNode=document.createElement("template"),this.templateNode.innerHTML=this.template):(this.templateNode=void 0,this.template=void 0),i.setCustomObserverReactiveMaps(t._impressInternal.iObservers,this._ireactive),e.set(this.name,this),customElements.define(this.name,class extends HTMLElement{constructor(){super()}connectedCallback(){m.connectComponent(this)}disconnectedCallback(){m.disconnectComponent(this)}})}}class u{#e;constructor(e){if(this.props={},this.data={},this._impressInternal={},void 0!==e){let r=e.localName,a=m.findParentComponentByNode(e),s=null==a?this:a._impressInternal.iRoot;this._impressInternal={name:r,iGuid:i.newGUID(),isConnected:!1,isMounted:!1,iEventAbort:new AbortController,reactiveLookupMaps:new Map,reactiveMaps:new Map,iNode:e,iParent:a,iRoot:s,iChildren:new Set,iReactive:null,iEvents:null,iSlotReactive:null,iSlotEvents:null,iObservers:new Map,template:void 0,templateNode:null,createKey:void 0,keys:[],controlFlags:{}},!0===Array.isArray(a?._impressInternal.keys)&&this._impressInternal.keys.push(...a._impressInternal.keys),null!=a?._impressInternal.createKey&&this._impressInternal.keys.push(a._impressInternal.createKey),this._impressInternal?.iParent?.createKey&&(this._impressInternal.controlFlags.isSkipRefresh=!0),this._impressInternal.iNode.setAttribute("i-guid",this._impressInternal.iGuid),t.set(this._impressInternal.iGuid,this)}}static register(t){const a=new t;if(a instanceof u){if(a.name="string"==typeof a.name?a.name.toLowerCase():void 0,null==a.name||null!=e.get(a.name))throw new Error(`iMpress error --- ${a.name} is invalid --- components must have a name property that is unique`);if(d.set(a.name,t),Array.isArray(a.mixins))for(let e=a.mixins.length-1;e>=0;e--){const s=a.mixins[e];if(s instanceof u){let e=Object.getOwnPropertyNames(s.prototype);for(let r of e)null==t.prototype[r]&&"function"==typeof s.prototype[r]&&(t.prototype[r]=s.prototype[r])}else r.warn("mixin",this)}return new c(a),!0}throw new Error(`iMpress error --- ${a.name} invalid class --- class must extend an instance of IMPRESS`)}get template(){return this.#e}set template(e){"string"==typeof e?e!==this.#e&&(!0!==this._impressInternal.isConnected?this.#e=e:(m.clearReactivity(this),this.#e=e,this.#e=p.correctHtml(this.#e),this.#e=p.iAttributesHtml(this.#e,this._impressInternal.iReactive,this._impressInternal.iEvents),this._impressInternal.templateNode=document.createElement("template"),this._impressInternal.templateNode.innerHTML=this.#e,this._impressInternal.templateNode=this._impressInternal.templateNode.content,!0===this._impressInternal.isMounted&&(this._impressInternal.isMounted=!1,m.createComponent(this)))):r.error("templateType",this)}iDefine(e,...t){switch(null==this._impressInternal.controlFlags&&(this._impressInternal.controlFlags={}),e){case"superProps":case"globalState":if("string"==typeof t[0]){!1===Array.isArray(this._impressInternal.controlFlags[e])&&(this._impressInternal.controlFlags[e]=new Set);for(let r of t)this._impressInternal.controlFlags[e].add(r)}break;case"isPassThrough":case"isShadowDOM":this._impressInternal.controlFlags[e]=!0===t[0];break;case"observer":null==this._impressInternal.iObservers&&(this._impressInternal.iObservers=new Map),this._impressInternal.iObservers.set(t[0],t[1]);break;case"isDebug":this._impressInternal.iRoot===this&&"boolean"==typeof t[0]&&(this._impressInternal.controlFlags[e]=t[0],r.setGlobalMethod(t[0]))}}iSetTemplate(e){"string"==typeof e?e!==this.template&&(!0!==this._impressInternal.isConnected?this.template=e:(m.clearReactivity(this),this.template=e,this.template=p.correctHtml(this.template),this.template=p.iAttributesHtml(this.template,this._impressInternal.iReactive,this._impressInternal.iEvents),this._impressInternal.templateNode=document.createElement("template"),this._impressInternal.templateNode.innerHTML=this.template,this._impressInternal.templateNode=this._impressInternal.templateNode.content,!0===this._impressInternal.isMounted&&(this._impressInternal.isMounted=!1,m.createComponent(this)))):r.error("templateType",this)}iSetState(e,...t){m.setState(this,e,t)}iGetState(e){return m.getState(this,e)}iDestroy(){let e=this._impressInternal.iNode.host??this._impressInternal.iNode;null!=e?.parentNode&&e.parentNode.removeChild(e)}iClosest(e){return m.iClosest(this,e)}iQuerySelector(e){return m.iQuerySelector(this,e)}iQuerySelectorAll(e){return m.iQuerySelectorAll(this,e)}iGetComponentByNode(e){return m.getComponentByNode(e)}iGetComponentById(e){return m.getComponentById(e)}iGetComponentsByName(e){return m.getComponentsByName(e)}iWait(){return new Promise((e=>setTimeout((()=>e()),time)))}}m.connectComponent=e=>{if(!1===e.isConnected)return;let r=e.getAttribute("i-guid"),a=t.get(r);if(null==a){let t=new(d.get(e.localName)??u)(e);null!=t._impressInternal.iParent?(t._impressInternal.iParent._impressInternal.iChildren.add(t),!0===t._impressInternal.iParent._impressInternal.isMounted&&m.createComponent(t)):m.createComponent(t)}else e!==a._impressInternal.iNode&&(e.removeAttribute("i-guid"),m.connectComponent(e))},m.clearReactivity=e=>{e._impressInternal.iReactive=new Map,e._impressInternal.iEvents=new Map,e._impressInternal.iObservers.clear(),e._impressInternal.reactiveLookupMaps.clear(),e._impressInternal.reactiveMaps.clear(),e._impressInternal.iEventAbort=new AbortController},m.createComponent=async t=>{let r=e.get(t._impressInternal.name);if(t._impressInternal.isConnected=!0,m.setiPropsMaps(t),"function"==typeof t.beforeCreate&&await t.beforeCreate(t),null==t._impressInternal.iReactive&&(t._impressInternal.iReactive=r._ireactive),null==t._impressInternal.iEvents&&(t._impressInternal.iEvents=r._ievents),null==t._impressInternal.templateNode&&(t._impressInternal.templateNode=r.templateNode.content.cloneNode(!0)),!1===t._impressInternal.controlFlags.isShadowDOM)t._impressInternal.iNode.innerHTML="",""!==t.template&&t._impressInternal.iNode.appendChild(t._impressInternal.templateNode);else{if(t._impressInternal.iNode.childNodes.length>0){let e=t._impressInternal.iNode.innerHTML;t._impressInternal.iSlotReactive=new Map,t._impressInternal.iSlotEvents=new Map,e=p.iAttributesHtml(e,t._impressInternal.iSlotReactive,t._impressInternal.iSlotEvents),t._impressInternal.iNode.innerHTML=e}const e=t._impressInternal.iNode.host?t._impressInternal.iNode:t._impressInternal.iNode.attachShadow({mode:"open"});e.childNodes.length>0&&(e.innerHTML=""),e.appendChild(t._impressInternal.templateNode),t._impressInternal.iNode=e}m.setiReactiveMaps(t),"i-for"!==t.name&&"i-if"!==t.name&&(m.setiEventMaps(t,void 0,t._impressInternal.iSlotEvents),m.setiEventMaps(t,void 0,t._impressInternal.iEvents)),t._impressInternal.iChildren.forEach((e=>{m.createComponent(e)})),t._impressInternal.isMounted=!0,"function"==typeof t.afterMounted&&await t.afterMounted(t)},m.findParentComponentByNode=function(t){let r=null!=t.parentNode.host?t.parentNode.host:t.parentNode,a=r.localName;for(;"body"!==r.localName&&null==e.get(a);)r=null!=r.parentNode.host?r.parentNode.host:r.parentNode,a=r.localName;return"body"!==a?m.getComponentByNode(r):void 0},m.disconnectComponent=async e=>{let r=e.getAttribute("i-guid"),a=t.get(r);if(null!=a){if(!0===e.isConnected){let e=a._impressInternal.iParent;return"function"==typeof a.afterPortedFrom&&await a.afterPorted(),void(null!=e&&"function"==typeof e.afterPorted&&await e.afterPorted(a))}0===a._impressInternal.iChildren.size||a._impressInternal.iChildren.forEach((e=>{m.destroyComponent(e)})),m.destroyComponent(a)}},m.destroyComponent=async e=>{if("function"==typeof e.beforeDestroy&&await e.beforeDestroy(e),null!=e._impressInternal.iParent&&!0===e._impressInternal.iParent._impressInternal.iChildren.has(e)&&e._impressInternal.iParent._impressInternal.iChildren.delete(e),e._impressInternal.iEventAbort.abort(),"function"==typeof e.afterDestroy&&await e.afterDestroy(e),!0===e._impressInternal.iNode.isConnected){let r=e._impressInternal.iNode;t.delete(e._impressInternal.iGuid),r.parentNode.removeChild(r)}else t.delete(e._impressInternal.iGuid)},m.setiPropsMaps=e=>{let t=null!=e._impressInternal.iNode.host?e._impressInternal.iNode.host:e._impressInternal.iNode;if(null!=e._impressInternal.iParent){let a=t.attributes;for(let t of a)if("{data"===t.value.substring(0,5)||"{props"===t.value.substring(0,6)){let a,s=e._impressInternal.iParent,n=t.value.substring(1,t.value.length-1),l="props."+t.name,o=!0===e._impressInternal.controlFlags.globalState?.has(l)?e._impressInternal.iRoot:s;if(a=null==s.data.cachedMaps||null==s.data.cachedMaps.get(l)?i.getReactiveMap(o,n,i.newGUID(),l):s.data.cachedMaps.get(l),null!=a){let o=i.isComponentHasOwnData(a,e._impressInternal.keys);if(!1===o){let t=e._impressInternal.controlFlags.superProps?.has(l),p=s?._impressInternal.controlFlags.isPassThrough??!1;for(;!1===o&&(!0===p||!0===t);)s=s._impressInternal.iParent,a=i.getReactiveMap(s,n,i.newGUID(),l),o=i.isComponentHasOwnData(a,e._impressInternal.keys),p=s?._impressInternal.controlFlags.isPassThrough??!1;!0!==o&&r.error("setiPropsMaps",e,l,n)}i.setReactiveMap(e,l,a,!1);let p=i.getValueFromLookup(a.resolvedDataOwner,a.reactiveSubMap,a.resolvedDataPathArray,e._impressInternal.keys);e.props[t.name]=p,"i-for"===e._impressInternal.iParent._impressInternal.name&&e._impressInternal.iParent.data.cachedMaps.set(l,a)}}}},m.setiReactiveMaps=e=>{if(null!=e._impressInternal.iSlotReactive){let t=null!=e._impressInternal.iNode.host,r=!0===t?e._impressInternal.iNode.host:e._impressInternal.iNode;e._impressInternal.iSlotReactive.forEach(((a,s)=>{let n=i.getReactiveMapFromBaseMap(e,a,s,e._impressInternal.iParent,t);if(null!=n){let a=!0===t?`slot.${n.name}`:n.name;i.setReactiveMap(e,a,n),"function"!=typeof e.iRender&&i.setReactiveDataToDOM(e,r,n,!0,e._impressInternal.keys)}}))}e._impressInternal.iReactive.forEach(((t,r)=>{let a=i.getReactiveMapFromBaseMap(e,t,r);null!=a&&(i.setReactiveMap(e,a.name,a),"i-for"!==e.name&&"i-if"!==e.name&&i.setReactiveDataToDOM(e,e._impressInternal.iNode,a,!0,e._impressInternal.keys))}))},m.setiEventMaps=function(e,t,a){null!=a&&a.forEach(((a,s)=>{let n;n=null==t?e._impressInternal.iNode.querySelector(`[i-attribute="${s}"]`):t.querySelector(`[i-attribute="${s}"]`),a.forEach(((t,a)=>{for(let s of t){let t=s[0],l=s.slice(1),o=e;for(;null!=o&&"function"!=typeof o[t]&&!0===o._impressInternal.controlFlags.isPassThrough;)o=o._impressInternal.iParent;if("function"==typeof o[t]){let r={signal:e._impressInternal.iEventAbort.signal};n.addEventListener(a,(e=>{let r=[];for(let t,a=0;void 0!==(t=l[a]);a++){if("$e"===t||"$event"===t)t=e;else if(parseFloat(t)===Number(t))t=parseFloat(t);else if("true"===t||"false"===t)t=Boolean(t);else if("data."===t.substring(0,5)||"props."===t.substring(0,6)){let e=t.match(/[^\[\]\.\{\}]+/g),r=o;if("props"===e[0]){let a=i.getPropMap(r,void 0,e),s=[...a.resolvedDataPathArray,...e.slice(2)];t=i.getDataFromPath(a.resolvedDataOwner,s)}else t=i.getDataFromPath(r,e)}r.push(t)}o[t](...r)}),r)}else r.error("setiEventMaps",o,a,t)}}))}))},m.setState=(e,t,a)=>{if("string"==typeof t&&(t=t.match(/[^\[\]\.\{\}]+/g)),"props"===t[0]){let{resolvedDataPathArray:s,resolvedDataOwner:n}=i.getResolvedDataPathArrayWithResolvedKeys(e,void 0,t);a.length>0&&i.setDataFromPath(n,s,a[0]),!0===e._impressInternal.iRoot._impressInternal.controlFlags.isDebug&&r.setStateChangeLog(e,t,n,s),i.updateAllChildren(n,s)}else"data"===t[0]&&(a.length>0&&i.setDataFromPath(e,t,a[0]),!0===e._impressInternal.iRoot._impressInternal.controlFlags.isDebug&&r.setStateChangeLog(e,t,e,t),i.updateAllChildren(e,t))},m.getState=(e,t)=>{if("props"===(t="string"==typeof t?t.match(/[^\[\]\.\{\}]+/g):t.slice())[0]){let{resolvedDataPathArray:a,resolvedDataOwner:s}=i.getResolvedDataPathArrayWithResolvedKeys(e,void 0,t),n=r.getStateChangeLog(s,a);return{dataOwner:s._impressInternal.name,dataPath:a,value:i.getDataFromPath(s,a),stateChangeLog:n}}if("data"===t[0]){let a=r.getStateChangeLog(e,t);return{dataOwner:e._impressInternal.name,dataPath:t,value:i.getDataFromPath(e,t),stateChangeLog:a}}},m.queryObjectMatch=(e,t,r)=>(!1===Object.hasOwn(e,"value")&&!1===Object.hasOwn(e,"notValue")?null==t&&(r=void 0):!0===Object.hasOwn(e,"value")?t!==e.value&&(r=void 0):!0===Object.hasOwn(e,"notValue")&&t===e.notValue&&(r=void 0),r),m.isQueryMatch=(e,t,r,a,s)=>{let n=e;if(null!=t)for(let r=0;r<t.length;r++){let a=i.getDataFromPath(e,t[r].path);if(n=m.queryObjectMatch(t[r],a,n),null==n)break}if(null!=r)for(let t=0;t<r.length;t++){let a=i.getDataFromPath(e,r[t].path);if(n=m.queryObjectMatch(r[t],a,n),null==n)break}if(null!=a&&!1===a.includes(e._impressInternal.name)&&(n=void 0),null!=s)for(let t=0;t<s.length;t++)if("function"!=typeof e[s[t]]){n=void 0;break}return n},m.iQuerySelector=(e,t)=>{let r,a=Array.isArray(t.data)||null==t.data?t.data:[t.data],s=Array.isArray(t.methods)||null==t.methods?t.methods:[t.methods],i=Array.isArray(t.name)||null==t.name?t.name:[t.name],n=Array.isArray(t.props)||null==t.props?t.props:[t.props],l=[e._impressInternal.iChildren];for(let e=0;e<l.length;e++){let t=l[e];for(let e of t){if(r=m.isQueryMatch(e,a,s,i,n),null!=r)break;e._impressInternal.iChildren.size>0&&l.push(e._impressInternal.iChildren)}if(null!=r)break}return r},m.iQuerySelectorAll=(e,t)=>{let r=Array.isArray(t.data)||null==t.data?t.data:[t.data],a=Array.isArray(t.methods)||null==t.methods?t.methods:[t.methods],s=Array.isArray(t.name)||null==t.name?t.name:[t.name],i=Array.isArray(t.props)||null==t.props?t.props:[t.props],n=[],l=[e._impressInternal.iChildren];for(let e=0;e<l.length;e++){let t=l[e];for(let e of t){let t=m.isQueryMatch(e,r,a,s,i);null!=t&&n.push(t),e._impressInternal.iChildren.size>0&&l.push(e._impressInternal.iChildren)}}return n},m.iClosest=(e,t)=>{let r,a=Array.isArray(t.data)||null==t.data?t.data:[t.data],s=Array.isArray(t.methods)||null==t.methods?t.methods:[t.methods],i=Array.isArray(t.name)||null==t.name?t.name:[t.name],n=Array.isArray(t.props)||null==t.props?t.props:[t.props],l=e._impressInternal.iParent;for(;null!=l&&null==r;)r=m.isQueryMatch(l,a,s,i,n),l=l._impressInternal.iParent;return r},m.getComponentByNode=e=>{if(null!=e){let r=e.getAttribute("i-guid");return t.get(r)}},m.getComponentById=e=>t.get(e),m.getComponentsByName=e=>{let r=[];return t.forEach(((t,a)=>{t._impressInternal.name===e&&r.push(t)})),r};u.register(class extends u{#t=void 0;#r=0;#a=new Map;#s=!1;#i;#e;constructor(e){super(e),this.name="i-for",this.#i=document.createElement("template"),this.data.cachedMaps=new Map,this.data.iterablePropName=void 0,this._impressInternal.iSlotReactive=new Map,this._impressInternal.iSlotEvents=new Map,this.iDefine("observer","props.of","propsOf"),this.iDefine("isPassThrough",!0),this.iDefine("isShadowDOM",!1)}beforeCreate(){let e=this._impressInternal.iNode.innerHTML,t=this._impressInternal.iNode.getAttribute("let");if(this.data.iterablePropName=t.trim(),1===this._impressInternal.iNode.children.length&&(this.#s=!0),this._impressInternal.iNode.children.length>0){if(null!=e&&""!==e){let t=e;t=t.replaceAll(`{${this.data.iterablePropName}`,"{props.of.?"),this.#e=p.iAttributesHtml(t,this._impressInternal.iSlotReactive,this._impressInternal.iSlotEvents)}this.#i.innerHTML=this.#e}this._impressInternal.iNode.innerHTML=""}afterMounted(){try{!0===Array.isArray(this.props.of)?this.#t="Array":this.props.of instanceof Set?this.#t="Set":this.props.of instanceof Map&&(this.#t="Map"),null==this.#t&&r.error("i-for",this),this.propsOf(this.props.of)}catch(e){console.error(e),this.iDestroy()}}iRender(e,t=!1,r){e.targetMap.forEach(((a,s)=>{if("OBSERVER"===a){if(!1===t){let t=this._impressInternal.iObservers.get(e.name);"function"==typeof this[t]&&this[t](r)}}else"TEXT"===a?this.props.of.forEach(((t,r)=>{let a=this.#a.get(r);if(null!=a){let t=i.getValueFromLookup(e.resolvedDataOwner,e.reactiveSubMap,e.resolvedDataPathArray,[...this._impressInternal.keys,r]);if(!0===this.#s)i.refreshTextNodes(a,s,t);else for(let e=0;e<a.length;e++)i.refreshTextNodes(a[e],s,t)}})):"props"!==a.substring(0,5)&&this.props.of.forEach(((t,r)=>{let n=this.#a.get(r);if(null!=n){let t=i.getValueFromLookup(e.resolvedDataOwner,e.reactiveSubMap,e.resolvedDataPathArray,[...this._impressInternal.keys,r]);if(!0===this.#s)i.refreshAttribute(n,s,a,t,!1);else for(let e=0;e<n.length;e++)i.refreshAttribute(n[e],s,a,t,!1)}}))}))}propsOf(e){let t=Array.isArray(e)?e.length:e.size;if((0===t||null==t)&&0===t)return this.#a.clear(),this._impressInternal.iChildren.clear(),this._impressInternal.iNode.innerHTML="",void(this.#r=t);if(this.#r!==t)if(this.#r<t){let r=0;e.forEach(((e,t)=>{if(r>=this.#r){let e=this.#i.content.cloneNode(!0);if(m.setiEventMaps(this,e,this._impressInternal.iSlotEvents),this._impressInternal.reactiveMaps.forEach((r=>{i.setReactiveDataToDOM(this,e,r,!0,[...this._impressInternal.keys,t])})),!0===this.#s)this.#a.set(t,e.children[0]);else{let r=Array.from(e.childNodes);this.#a.set(t,r)}this._impressInternal.createKey=t,this._impressInternal.iNode.appendChild(e)}r++})),this.#r=t}else this.#a.forEach(((t,r)=>{Array.isArray(e)?!1===e.includes(r)&&(t.remove(),this.#a.delete(r)):!1===e.has(r)&&(t.remove(),this.#a.delete(r))})),this.#r=t}}),u.register(class extends u{#i;#e;constructor(e){super(e),this.name="i-if",this.#i=document.createElement("template"),this.iDefine("observer","props.condition","propsCondition"),this.iDefine("isPassThrough",!0),this.iDefine("isShadowDOM",!1)}beforeCreate(){let e=this._impressInternal.iNode.innerHTML,t=this._impressInternal.iNode.getAttribute("condition");if(null==t||"{props"!==t.substring(0,6)&&"{data"!==t.substring(0,5))r.error("i-if",this);else if(this._impressInternal.iNode.children.length>0){if(null!=e&&""!==e){let t=e;t=this.template.replaceAll(`{${this.data.iterablePropName}`,"{props.of.?"),this.#e=p.iAttributesHtml(t,this._impressInternal.iSlotReactive,this._impressInternal.iSlotEvents)}this.#i.innerHTML=this.#e}this._impressInternal.iNode.innerHTML=""}afterMounted(){!0===Object.hasOwn(this.props,"condition")?this.propsCondition(this.props.condition):r.error("i-if",this)}iRender(e,t=!1,r){e.targetMap.forEach(((a,s)=>{if("OBSERVER"===a&&!1===t){let t=this._impressInternal.iObservers.get(e.name);"function"==typeof this[t]&&this[t](r)}}))}propsCondition(e){if(e){let e=this.#i.content.cloneNode(!0);m.setiEventMaps(this,e,this._impressInternal.iSlotEvents),this._impressInternal.reactiveMaps.forEach((t=>{i.setReactiveDataToDOM(this,e,t,!0,this._impressInternal.keys)})),this._impressInternal.iNode.appendChild(e)}else this._impressInternal.iChildren.clear(),this._impressInternal.iNode.innerHTML=""}});export{u as IMPRESS};
